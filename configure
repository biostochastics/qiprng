#!/bin/sh

# Find pkg-config, checking common Homebrew paths for macOS
PKG_CONFIG_PATH=""
if command -v pkg-config >/dev/null 2>&1; then
  PKG_CONFIG_PATH=$(command -v pkg-config)
elif [ -x "/opt/homebrew/bin/pkg-config" ]; then
  PKG_CONFIG_PATH="/opt/homebrew/bin/pkg-config"
elif [ -x "/usr/local/bin/pkg-config" ]; then
  PKG_CONFIG_PATH="/usr/local/bin/pkg-config"
else
  echo "Error: pkg-config not found. Please install it and ensure it's in your PATH." >&2
  exit 1
fi

# Use pkg-config to get the required flags
CPPFLAGS=$($PKG_CONFIG_PATH --cflags gmp mpfr libsodium openssl)
LIBS=$($PKG_CONFIG_PATH --libs gmp mpfr libsodium openssl)

# Check if pkg-config found the libraries
if [ -z "$CPPFLAGS" ] || [ -z "$LIBS" ]; then
    echo "Error: Could not find required libraries (gmp, mpfr, libsodium, openssl) via pkg-config." >&2
    echo "Please ensure they are installed correctly." >&2
    exit 1
fi

# Check for Eigen3 (optional)
EIGEN_CPPFLAGS=""
EIGEN_DEFINE=""
if $PKG_CONFIG_PATH --exists eigen3 2>/dev/null; then
    EIGEN_CPPFLAGS=$($PKG_CONFIG_PATH --cflags eigen3)
    EIGEN_DEFINE="-DHAVE_EIGEN"
    echo "Found Eigen3 - enabling multivariate normal and Gaussian copula distributions"
else
    echo "Warning: Eigen3 not found - multivariate normal and Gaussian copula will be disabled"
fi

# Create the src/Makevars file
cat << EOF > src/Makevars
# This file is generated by configure. Do not edit by hand.

PKG_CPPFLAGS = $CPPFLAGS $EIGEN_CPPFLAGS -DUSE_MPFR $EIGEN_DEFINE
PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS) -O3 -march=native -mtune=native
PKG_LIBS = $LIBS
CXX_STD = CXX17
EOF

exit 0
