#!/bin/sh

# Find pkg-config, checking common Homebrew paths for macOS
PKG_CONFIG_PATH=""
if command -v pkg-config >/dev/null 2>&1; then
  PKG_CONFIG_PATH=$(command -v pkg-config)
elif [ -x "/opt/homebrew/bin/pkg-config" ]; then
  PKG_CONFIG_PATH="/opt/homebrew/bin/pkg-config"
elif [ -x "/usr/local/bin/pkg-config" ]; then
  PKG_CONFIG_PATH="/usr/local/bin/pkg-config"
else
  echo "Error: pkg-config not found. Please install it and ensure it's in your PATH." >&2
  exit 1
fi

# Use pkg-config to get the required flags
CPPFLAGS=$($PKG_CONFIG_PATH --cflags gmp mpfr libsodium openssl)
LIBS=$($PKG_CONFIG_PATH --libs gmp mpfr libsodium openssl)

# Check if pkg-config found the libraries
if [ -z "$CPPFLAGS" ] || [ -z "$LIBS" ]; then
    echo "Error: Could not find required libraries (gmp, mpfr, libsodium, openssl) via pkg-config." >&2
    echo "Please ensure they are installed correctly." >&2
    exit 1
fi

# Create the src/Makevars file
cat << EOF > src/Makevars
# This file is generated by configure. Do not edit by hand.

PKG_CPPFLAGS = $CPPFLAGS -DUSE_MPFR
PKG_LIBS = $LIBS
CXX_STD = CXX14
EOF

exit 0
