#!/bin/sh

# QIPRNG Configure Script
# Detects required libraries and generates src/Makevars

echo "Configuring qiprng..."

# Find pkg-config, checking common paths
PKG_CONFIG=""
if command -v pkg-config >/dev/null 2>&1; then
    PKG_CONFIG=$(command -v pkg-config)
elif [ -x "/opt/homebrew/bin/pkg-config" ]; then
    PKG_CONFIG="/opt/homebrew/bin/pkg-config"
elif [ -x "/usr/local/bin/pkg-config" ]; then
    PKG_CONFIG="/usr/local/bin/pkg-config"
fi

if [ -z "$PKG_CONFIG" ]; then
    echo "--------------------------------------------------------------------" >&2
    echo "ERROR: 'pkg-config' not found." >&2
    echo "" >&2
    echo "Please install pkg-config and ensure it is in your PATH." >&2
    echo "  On macOS (Homebrew): brew install pkg-config" >&2
    echo "  On Debian/Ubuntu:    sudo apt-get install pkg-config" >&2
    echo "  On Fedora/RHEL:      sudo dnf install pkgconf-pkg-config" >&2
    echo "--------------------------------------------------------------------" >&2
    exit 1
fi

echo "Found pkg-config: $PKG_CONFIG"

# Check if pkg-config can find the libraries using --exists (more robust than checking flags)
# This correctly handles libraries installed in standard system paths where flags may be empty
if ! $PKG_CONFIG --exists gmp mpfr libsodium openssl 2>/dev/null; then
    echo "--------------------------------------------------------------------" >&2
    echo "ERROR: Could not find one or more required libraries via pkg-config:" >&2
    echo "  gmp, mpfr, libsodium, openssl" >&2
    echo "" >&2
    echo "Please ensure these libraries are installed:" >&2
    echo "  On macOS (Homebrew): brew install gmp mpfr libsodium openssl" >&2
    echo "  On Debian/Ubuntu:    sudo apt-get install libgmp-dev libmpfr-dev libsodium-dev libssl-dev" >&2
    echo "  On Fedora/RHEL:      sudo dnf install gmp-devel mpfr-devel libsodium-devel openssl-devel" >&2
    echo "--------------------------------------------------------------------" >&2
    exit 1
fi

# Use pkg-config to get the required flags for mandatory libraries
# Note: These may be empty if libraries are in standard system paths, which is fine
PKG_CPPFLAGS=$($PKG_CONFIG --cflags gmp mpfr libsodium openssl 2>/dev/null)
PKG_LIBS=$($PKG_CONFIG --libs gmp mpfr libsodium openssl 2>/dev/null)

echo "Found required libraries: gmp, mpfr, libsodium, openssl"

# Check for Eigen3 (optional - enables multivariate distributions)
EIGEN_CPPFLAGS=""
EIGEN_DEFINE=""
if $PKG_CONFIG --exists eigen3 2>/dev/null; then
    EIGEN_CPPFLAGS=$($PKG_CONFIG --cflags eigen3)
    EIGEN_DEFINE="-DHAVE_EIGEN"
    echo "Found Eigen3: Multivariate normal and Gaussian copula enabled."
else
    echo "Note: Eigen3 not found. Multivariate features will be disabled."
    echo "  To enable: brew install eigen (macOS) or apt-get install libeigen3-dev (Ubuntu)"
fi

# Generate src/Makevars
cat << EOF > src/Makevars
# This file is generated by configure. Do not edit by hand.

PKG_CPPFLAGS = ${PKG_CPPFLAGS} ${EIGEN_CPPFLAGS} -DUSE_MPFR ${EIGEN_DEFINE}
PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS) -O3
PKG_LIBS = ${PKG_LIBS}
CXX_STD = CXX17
EOF

echo ""
echo "Configuration complete. src/Makevars has been generated."
echo "Run 'R CMD INSTALL .' to build and install the package."

exit 0
