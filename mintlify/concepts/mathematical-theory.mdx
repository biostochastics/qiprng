---
title: 'Mathematical Foundations'
description: 'The mathematical theory behind quadratic irrational PRNGs'
sidebarTitle: 'Mathematical Theory'
---

# Mathematical Foundations

The qiprng generator is built on the mathematical properties of quadratic irrational numbers and their continued fraction expansions. This page provides a comprehensive overview of the underlying theory.

## Quadratic Irrationals

A **quadratic irrational** is a number that can be expressed in the form:

$$\alpha = \frac{a + \sqrt{d}}{c}$$

where $a$, $c$, and $d$ are integers, and $d$ is not a perfect square. These numbers are roots of quadratic equations with integer coefficients.

### Key Properties

<Accordion title="Algebraic Properties">
1. **Irreducibility**: The minimal polynomial of $\alpha$ is of degree 2
2. **Conjugate**: The conjugate $\bar{\alpha} = \frac{a - \sqrt{d}}{c}$
3. **Discriminant**: $\Delta = b^2 - 4ac$ must be positive and not a perfect square
4. **Field Extension**: $\alpha \in \mathbb{Q}(\sqrt{d})$
</Accordion>

<Accordion title="Continued Fraction Properties">
Every quadratic irrational has a **periodic** continued fraction expansion:

$$\alpha = a_0 + \cfrac{1}{a_1 + \cfrac{1}{a_2 + \cfrac{1}{a_3 + \cdots}}}$$

Written compactly as $\alpha = [a_0; a_1, a_2, \ldots, a_{k-1}, \overline{a_k, \ldots, a_{k+p-1}}]$

where the overline indicates the periodic part with period $p$.
</Accordion>

## The PRNG Recurrence Relation

The generator implements the quadratic map:

$$x_{n+1} = (a \cdot x_n^2 + b \cdot x_n + c) \bmod 1$$

This creates a sequence in $[0,1)$ with the following properties:

### Ergodic Properties

<Note>
**Theorem**: For appropriate choices of $(a, b, c)$ satisfying $b^2 - 4ac > 0$ (non-perfect square), the quadratic map exhibits ergodic behavior with uniform invariant measure on $[0,1)$.
</Note>

The ergodicity ensures:
- **Uniform distribution** of generated values
- **Statistical independence** of successive values
- **Long periods** before repetition

### Period Analysis

The period of the generator is related to the period of the continued fraction expansion:

$$\text{Period}(x_n) = \text{lcm}(p_1, p_2, \ldots, p_k)$$

where $p_i$ are the periods of individual quadratic irrationals in the ensemble.

## Continued Fraction Expansion Algorithm

The CFE algorithm extracts integer coefficients from the quadratic irrational:

<CodeGroup>
```python Algorithm
def continued_fraction_expansion(a, b, c, d):
    """
    Compute CFE for (a + sqrt(d))/c
    """
    coefficients = []
    seen = {}  # For period detection

    while (a, c) not in seen:
        seen[(a, c)] = len(coefficients)

        # Extract integer part
        q = floor((a + sqrt(d)) / c)
        coefficients.append(q)

        # Update for next iteration
        a_new = q * c - a
        c_new = (d - a_new**2) // c

        a, c = a_new, c_new

    period_start = seen[(a, c)]
    return coefficients, period_start
```

```cpp Implementation
void computeCFE(long a, long d, long c,
                std::vector<long>& coeffs) {
    std::unordered_map<std::pair<long,long>, int> seen;

    while (seen.find({a, c}) == seen.end()) {
        seen[{a, c}] = coeffs.size();

        // Integer part using MPFR for precision
        mpfr_t sqrt_d, temp;
        mpfr_init2(sqrt_d, precision);
        mpfr_sqrt_ui(sqrt_d, d, MPFR_RNDN);

        long q = mpfr_get_si(temp, MPFR_RNDN);
        coeffs.push_back(q);

        // Recurrence update
        long a_new = q * c - a;
        long c_new = (d - a_new * a_new) / c;

        a = a_new;
        c = c_new;
    }
}
```
</CodeGroup>

## Jump-Ahead Algorithms

The generator supports O(log n) jump-ahead using four different algorithms:

### 1. Matrix Exponentiation (128-bit)

The CFE recurrence can be expressed as matrix multiplication:

$$\begin{bmatrix} x_{n+1} \\ 1 \end{bmatrix} = M_n \begin{bmatrix} x_n \\ 1 \end{bmatrix}$$

where $M_n = \begin{bmatrix} a_n & b_n \\ c_n & d_n \end{bmatrix}$

Jump-ahead by $k$ steps: $M^k = M^{k/2} \cdot M^{k/2}$ (binary exponentiation)

**Complexity**: $O(\log k)$ matrix multiplications
**Limitation**: May overflow for very large jumps

### 2. MPFR High-Precision Matrix

Uses arbitrary precision arithmetic:

$$M^k \bmod p \text{ where } p \text{ is the period}$$

**Complexity**: $O(\log k \cdot \log B)$ where $B$ is bit precision
**Advantage**: No overflow, handles astronomical jumps

### 3. Modular Mersenne Prime

Performs arithmetic modulo $2^{61} - 1$ (Mersenne prime):

$$M^k \bmod (2^{61} - 1)$$

**Complexity**: $O(\log k)$ with fast modular reduction
**Advantage**: Fast and overflow-free

### 4. Direct CFE Manipulation

Directly computes the $k$-th CFE coefficient without matrices:

$$a_k = f(a_0, k, \text{period})$$

**Complexity**: $O(\log k)$ using number theory
**Advantage**: Avoids matrix operations entirely

## Statistical Properties

### Uniformity

<Note>
**Theorem (Weyl's Criterion)**: The sequence $(x_n)$ is equidistributed in $[0,1)$ if and only if:

$$\lim_{N \to \infty} \frac{1}{N} \sum_{n=1}^{N} e^{2\pi i k x_n} = 0$$

for all integers $k \neq 0$.
</Note>

### Autocorrelation

The autocorrelation function for lag $k$:

$$\rho_k = \frac{\mathbb{E}[(X_n - \mu)(X_{n+k} - \mu)]}{\sigma^2}$$

For our generator with excellent discriminants: $|\rho_k| < 0.01$ for all $k > 0$.

### Entropy

The generator achieves near-maximal entropy:

$$H = -\sum_{i} p_i \log_2 p_i \approx \log_2 n$$

where $n$ is the number of possible states.

## Security Analysis

### Cryptographic Mixing

The ChaCha20 stream cipher provides:

$$y_n = x_n \oplus \text{ChaCha20}(\text{key}, \text{nonce}, n)$$

This ensures:
- **Forward secrecy**: Cannot predict future values from past
- **Backward secrecy**: Cannot reconstruct past values
- **Uniform distribution preservation**: XOR maintains uniformity

### Complexity Theory

<Warning>
**Computational Hardness**: Predicting the next value without knowing the internal state requires solving the **quadratic congruence problem**, which is computationally hard for large parameters.
</Warning>

## Performance Analysis

### Time Complexity

| Operation | Complexity | Typical Time |
|-----------|------------|--------------|
| Next value | $O(1)$ amortized | 122 ns |
| Jump-ahead by $n$ | $O(\log n)$ | 15 μs for $n = 10^6$ |
| Initialization | $O(p)$ where $p$ is period | 50 ms |
| Buffer refill | $O(B)$ where $B$ is buffer size | 125 μs for $B = 1024$ |

### Space Complexity

- **State storage**: $O(p)$ for CFE coefficients
- **Buffer**: $O(B)$ for pre-generated values
- **Thread-local**: $O(T \cdot S)$ where $T$ is threads, $S$ is state size

## References

<CardGroup cols={2}>
  <Card title="Granville (2022)" href="https://mltechniques.com/2022/12/13/military-grade-fast-random-number-generator-based-on-quadratic-irrationals/">
    Original quadratic irrational PRNG paper
  </Card>
  <Card title="Knuth TAOCP Vol. 2">
    Seminumerical Algorithms - RNG theory
  </Card>
  <Card title="L'Ecuyer (1999)">
    Tables of linear congruential generators
  </Card>
  <Card title="NIST SP 800-22">
    Statistical test suite for RNGs
  </Card>
</CardGroup>
